<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pixel Knight</title>

<style>
body {
    margin: 0;
    background: #202020;
    color: #fff;
    font-family: monospace;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100dvh;
    overflow: hidden;
}

canvas {
    image-rendering: pixelated;
    border: 2px solid #444;
    box-shadow: 0 0 20px rgba(0,0,0,0.6);

    /* üîë –ê–¥–∞–ø—Ç–∏–≤ */
    max-width: 100vw;
    max-height: 100vh;
    width: auto;
    height: auto;
}

#ui {
    position: absolute;
    top: 16px;
    font-size: 20px;
    text-shadow: 2px 2px 0 #000;
}

#message {
    position: absolute;
    bottom: 30px;
    font-size: 18px;
    background: rgba(0,0,0,0.7);
    padding: 12px 20px;
    border: 2px solid gold;
    display: none;
}

/* –ú–æ–±–∏–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
#controls {
    display: none;
    gap: 10px;
    margin-top: 16px;
}
.btn {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    border: 1px solid #fff;
    background: rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    user-select: none;
}
.btn:active {
    background: rgba(255,255,255,0.3);
}
@media (hover: none) {
    #controls { display: flex; }
}
</style>
</head>

<body>

<div id="ui">
    Coins: <span id="score">0</span> / <span id="total">0</span>
</div>

<div id="message">üèÜ –ü–æ–±–µ–¥–∞</div>

<canvas id="game"></canvas>

<div id="controls">
    <div class="btn" id="left">‚Üê</div>
    <div class="btn" id="up">‚Üë</div>
    <div class="btn" id="down">‚Üì</div>
    <div class="btn" id="right">‚Üí</div>
</div>

<script>
// ================== CONFIG ==================
const TILE = 32;
const MAP_W = 10;
const MAP_H = 10;

// ================== ASSETS ==================
const assets = {
    player: new Image(),
    wall: new Image(),
    grass: new Image(),
    coin: new Image()
};

assets.player.src = 'player.png';
assets.wall.src   = 'wall.png';
assets.grass.src  = 'grass.png';
assets.coin.src   = 'coin.png';

let loaded = 0;
const totalAssets = Object.keys(assets).length;

Object.values(assets).forEach(img => {
    img.onload = img.onerror = () => {
        loaded++;
        if (loaded === totalAssets) start();
    };
});

// ================== MAP ==================
const map = [
    [1,1,1,1,1,1,1,1,1,1],
    [1,0,0,0,1,2,0,0,2,1],
    [1,0,2,0,1,0,1,1,0,1],
    [1,0,0,0,0,0,0,0,0,1],
    [1,0,1,1,0,2,0,1,1,1],
    [1,0,0,0,0,0,0,0,0,1],
    [1,2,1,0,1,0,1,0,2,1],
    [1,0,1,0,1,2,1,0,0,1],
    [1,0,0,0,0,0,0,0,0,1],
    [1,1,1,1,1,1,1,1,1,1]
];

// ================== STATE ==================
const GameState = { PLAY: 0, WIN: 1 };
let gameState = GameState.PLAY;

const player = {
    x: 1, y: 1,
    rx: 1, ry: 1,
    tx: 1, ty: 1,
    speed: 0.2,
    moving: false
};

let coins = [];
let score = 0;

// Init coins
for (let y = 0; y < MAP_H; y++) {
    for (let x = 0; x < MAP_W; x++) {
        if (map[y][x] === 2) {
            coins.push({ x, y, taken: false });
            map[y][x] = 0;
        }
    }
}
document.getElementById('total').textContent = coins.length;

// ================== CANVAS ==================
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

canvas.width = MAP_W * TILE;
canvas.height = MAP_H * TILE;

// ================== GAME LOOP ==================
function start() {
    requestAnimationFrame(loop);
}

function update() {
    if (player.moving) {
        player.rx += (player.tx - player.rx) * player.speed;
        player.ry += (player.ty - player.ry) * player.speed;

        if (Math.abs(player.rx - player.tx) < 0.01 &&
            Math.abs(player.ry - player.ty) < 0.01) {
            player.rx = player.tx;
            player.ry = player.ty;
            player.moving = false;
        }
    }
}

function drawTile(img, x, y, color) {
    if (img.complete && img.naturalWidth) {
        ctx.drawImage(img, x*TILE, y*TILE, TILE, TILE);
    } else {
        ctx.fillStyle = color;
        ctx.fillRect(x*TILE, y*TILE, TILE, TILE);
    }
}

function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    for (let y=0;y<MAP_H;y++) {
        for (let x=0;x<MAP_W;x++) {
            drawTile(assets.grass, x, y, '#2d5a27');
            if (map[y][x] === 1) drawTile(assets.wall, x, y, '#777');
        }
    }

    const t = Date.now() * 0.005;
    coins.forEach(c => {
        if (!c.taken) {
            const oy = Math.sin(t) * 2;
            drawTile(assets.coin, c.x, c.y + oy / TILE, 'gold');
        }
    });

    drawTile(assets.player, player.rx, player.ry, 'lime');
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

// ================== CONTROL ==================
function move(dx, dy) {
    if (player.moving || gameState !== GameState.PLAY) return;

    const nx = player.x + dx;
    const ny = player.y + dy;

    if (nx<0 || ny<0 || nx>=MAP_W || ny>=MAP_H) return;
    if (map[ny][nx] === 1) return;

    player.x = nx;
    player.y = ny;
    player.tx = nx;
    player.ty = ny;
    player.moving = true;

    coins.forEach(c => {
        if (!c.taken && c.x===nx && c.y===ny) {
            c.taken = true;
            score++;
            document.getElementById('score').textContent = score;
            if (score === coins.length) {
                gameState = GameState.WIN;
                document.getElementById('message').style.display = 'block';
            }
        }
    });
}

window.addEventListener('keydown', e => {
    if (e.key==='ArrowUp' || e.key==='w') move(0,-1);
    if (e.key==='ArrowDown' || e.key==='s') move(0,1);
    if (e.key==='ArrowLeft' || e.key==='a') move(-1,0);
    if (e.key==='ArrowRight' || e.key==='d') move(1,0);
});

left.onclick  = ()=>move(-1,0);
right.onclick = ()=>move(1,0);
up.onclick    = ()=>move(0,-1);
down.onclick  = ()=>move(0,1);
</script>

</body>
</html>
